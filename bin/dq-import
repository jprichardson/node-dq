#!/usr/bin/env node

var dq = require('../lib/dq.js')
var byline = require('byline')
var program = require('commander')
var fs = require('fs')
var path = require('path')

program
  .version(require('../package.json').version)
  .option('-h, --host [host]', 'host of redis server, the default is localhost')
  .option('-a, --auth [password]', 'password of redis server')
  .option('-p, --port [number]', 'port of redis server, the default is 6379')
  .option('-q, --queue <queueName>', 'name of the queue')
  .option('-s, --shuffle', 'insert in random order')
  .parse(process.argv)

var count = 0

program.name = program.queue
program.password = program.auth
dq.create(program, function(err, q){
  if (err) {
    console.error('Error: ' + err.message)
    process.exit(1)
  }

  var lineStream = byline(process.stdin)
  lineStream.on('data', function(line){
    if (program.shuffle) {
      q.enq(line, Math.random())
    } else {
      q.enq(line, count)
    }
    count += 1
  })

  lineStream.on('end', function(){
    setImmediate(function() {
      q.quit()
    })
  })
})

